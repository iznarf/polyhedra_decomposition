

















#include "conforming_insertion.h"
#include <CGAL/Segment_3.h>
#include <CGAL/Segment_2.h>
#include <CGAL/intersections.h>
#include <CGAL/Object.h>
#include <algorithm>
#include <limits>
#include <optional>
#include <variant>
#include <vector>
#include <iostream>
#include <unordered_map>

namespace df { namespace reg {

using K   = df::K;
using P2  = df::P2;
using P3  = df::P3;
using Tri = df::Tri2;
using Seg3 = CGAL::Segment_3<K>;
using Seg2 = CGAL::Segment_2<K>;



static inline P3 lift(const P2& p) {
    return P3(p.x(), p.y(), p.x()*p.x() + p.y()*p.y());
}


bool is_insertion_conforming(df::vertex_id id,
                             const df::InputData& D)
{
    const Tri& current = D.tri_current;
    const Tri& lower   = D.tri_lower;

    // 2D position of the vertex to be inserted
    const P2& d2 = D.points2d[id];
    P3        d3 = lift(d2);

    // locate in current triangulation
    Tri::Locate_type lt;
    int li; // index used if point lies on an edge
    Tri::Face_handle fh = current.locate(d2, lt, li);

    if (lt != Tri::FACE) {
        std::cout << "[conform] WARNING: insertion point is not inside a face, cannot check conforming\n";
        return false;
    }

    // face containing the point to be inserted
    auto va = fh->vertex(0);
    auto vb = fh->vertex(1);
    auto vc = fh->vertex(2);


    df::vertex_id ia = va->info();
    df::vertex_id ib = vb->info();
    df::vertex_id ic = vc->info();

      if (id == 5){
        // print ia, ib, ic
        std::cout << "[conform] Insertion check for vertex id " << id << " in face ("
                  << ia << "," << ib << "," << ic << ")\n";
    }


    const P2& a2 = va->point();
    const P2& b2 = vb->point();
    const P2& c2 = vc->point();

    // fast path: are (a,d), (b,d), (c,d) already in the lower triangulation?
    bool ad_in_lower = false;
    bool bd_in_lower = false;
    bool cd_in_lower = false;

    for (auto e = lower.finite_edges_begin();
         e != lower.finite_edges_end(); ++e)
    {
        auto f  = e->first;
        int  ei = e->second;

        auto vu = f->vertex(lower.cw(ei));
        auto vv = f->vertex(lower.ccw(ei));

        df::vertex_id u = vu->info();
        df::vertex_id v = vv->info();

        if ((u == ia && v == id) || (u == id && v == ia))
            ad_in_lower = true;
        if ((u == ib && v == id) || (u == id && v == ib))
            bd_in_lower = true;
        if ((u == ic && v == id) || (u == id && v == ic))
            cd_in_lower = true;
    }

    if (ad_in_lower && bd_in_lower && cd_in_lower) {
        std::cout << "[conform] all three edges (" << ia << "," << id << "), ("
                  << ib << "," << id << "), (" << ic << "," << id
                  << ") are already in lower triangulation -> insertion is conforming\n";
        return true;
    }
return false;
}
}}

    



    

 